/*
 * Copyright (C) 2006 Christoph Hohmann
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

#include <glib.h>

#include "cryptofs.h"
#include "libtest.h"

#define FILENAME "write.data"

char *filecontent;
struct TestData
{
    unsigned long count;
    long long offset;
    void *data;
} testdata[] = {
    {52, 224,
      "\x06\x00\x00\x00\x34\x00\x00\x00\x34\x80\x04\x08\x34\x80\x04\x08\xe0\x00\x00\x00\xe0\x00\x00\x00\x05\x00\x00\x00\x04\x00\x00\x00\x03\x00\x00\x00\x14\x01\x00\x00\x14\x81\x04\x08\x14\x81\x04\x08\x13\x00\x00\x00\x13\x00\x00\x00\x04\x00\x00\x00\x01\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x80\x04\x08\x00\x80\x04\x08\x98\x04\x00\x00\x98\x04\x00\x00\x05\x00\x00\x00\x00\x10\x00\x00\x01\x00\x00\x00\x98\x04\x00\x00\x98\x94\x04\x08\x98\x94\x04\x08\x04\x01\x00\x00\x08\x01\x00\x00\x06\x00\x00\x00\x00\x10\x00\x00"
      "\x02\x00\x00\x00\xac\x04\x00\x00\xac\x94\x04\x08\xac\x94\x04\x08\xc8\x00\x00\x00\xc8\x00\x00\x00\x06\x00\x00\x00\x04\x00\x00\x00\x04\x00\x00\x00(\x01\x00\x00(\x81\x04\x08(\x81\x04\x08 \x00\x00\x00 \x00\x00\x00\x04\x00\x00\x00\x04\x00\x00\x00Q\xe5td\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x06\x00\x00\x00\x04\x00\x00\x00"},
    {4976, 400,
      "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x14\x81\x04\x08\x00\x00\x00\x00\x03\x00\x01\x00\x00\x00\x00\x00(\x81\x04\x08\x00\x00\x00\x00\x03\x00\x02\x00\x00\x00\x00\x00H\x81\x04\x08\x00\x00\x00\x00\x03\x00\x03\x00\x00\x00\x00\x00p\x81\x04\x08\x00\x00\x00\x00\x03\x00\x04\x00\x00\x00\x00\x00\xc0\x81\x04\x08\x00\x00\x00\x00\x03\x00\x05\x00\x00\x00\x00\x00\x0a\x82\x04\x08\x00\x00\x00\x00\x03\x00\x06\x00\x00\x00\x00\x00\x14\x82\x04\x08\x00\x00\x00\x00\x03\x00\x07\x00"
      "\x00\x00\x00\x00\x34\x82\x04\x08\x00\x00\x00\x00\x03\x00\x08\x00\x00\x00\x00\x00<\x82\x04\x08\x00\x00\x00\x00\x03\x00\x09\x00\x00\x00\x00\x00T\x82\x04\x08\x00\x00\x00\x00\x03\x00\x0a\x00\x00\x00\x00\x00l\x82\x04\x08\x00\x00\x00\x00\x03\x00\x0b\x00\x00\x00\x00\x00\xb0\x82\x04\x08\x00\x00\x00\x00\x03\x00\x0c\x00\x00\x00\x00\x00\x64\x84\x04\x08\x00\x00\x00\x00\x03\x00\x0d\x00\x00\x00\x00\x00\x80\x84\x04\x08\x00\x00\x00\x00\x03\x00\x0e\x00\x00\x00\x00\x00\x94\x84\x04\x08\x00\x00\x00\x00\x03\x00\x0f\x00"
      "\x00\x00\x00\x00\x98\x94\x04\x08\x00\x00\x00\x00\x03\x00\x10\x00\x00\x00\x00\x00\xa0\x94\x04\x08\x00\x00\x00\x00\x03\x00\x11\x00\x00\x00\x00\x00\xa8\x94\x04\x08\x00\x00\x00\x00\x03\x00\x12\x00\x00\x00\x00\x00\xac\x94\x04\x08\x00\x00\x00\x00\x03\x00\x13\x00\x00\x00\x00\x00t\x95\x04\x08\x00\x00\x00\x00\x03\x00\x14\x00\x00\x00\x00\x00x\x95\x04\x08\x00\x00\x00\x00\x03\x00\x15\x00\x00\x00\x00\x00\x90\x95\x04\x08\x00\x00\x00\x00\x03\x00\x16\x00\x00\x00\x00\x00\x9c\x95\x04\x08\x00\x00\x00\x00\x03\x00\x17\x00"
      "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\x18\x00"},
    {296, 32,
      "\x04\x00\x00\x00\x10\x00\x00\x00\x01\x00\x00\x00GNU\x00\x00\x00\x00\x00\x02\x00\x00\x00\x04\x00\x00\x00\x01\x00\x00\x00"},
    {688, 36,
      "1\xed^\x89\xe1\x83\xe4\xf0PTRh\x80\x83\x04\x08h\xd0\x83\x04\x08QVhT\x83\x04\x08\xe8\xbb\xff\xff\xff\xf4\x90\x90"},
    {1152, 8,
      "\x03\x00\x00\x00\x01\x00\x02\x00"},
    {1424, 4,
      "\x00\x00\x00\x00"},
    {1436, 58,
      "\x00GCC: (GNU) 4.1.2 20061115 (prerelease) (Debian 4.1.1-21)\x00"},
    {1848, 32,
      "\x1c\x00\x00\x00\x02\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\xb0\x82\x04\x08\"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"},
    {1968, 305,
      "!\x00\x00\x00\x02\x00{\x00\x00\x00\x91\x00\x00\x00y\x00\x00\x00_IO_stdin_used\x00\x00\x00\x00\x00w\x00\x00\x00\x02\x00\x00\x00\x00\x00\x04\x01\x00\x00\x00\x00\xb0\x82\x04\x08\xd2\x82\x04\x08../sysdeps/i386/elf/start.S\x00/build/buildd/glibc-2.3.6.ds1/build-tre"
      "e/glibc-2.3.6/csu\x00GNU AS 2.17\x00\x01\x80\x8d\x00\x00\x00\x02\x00\x14\x00\x00\x00\x04\x01[\x00\x00\x00\xd4\x82\x04\x08\xd4\x82\x04\x08\x00\x00\x00\x00\x01\x34\x00\x00\x00\x45\x00\x00\x00\x02\xa4\x00\x00\x00\x04\x07\x02\x8c\x00\x00\x00\x01\x08\x02\xb1\x00\x00\x00\x02\x07\x02\x9f\x00\x00\x00\x04\x07\x02\x8e\x00\x00\x00\x01\x06\x02;\x00\x00\x00\x02\x05\x03int\x00\x04\x05\x02~\x00\x00\x00\x08\x05\x02\x9a\x00"
      "\x00\x00\x08\x07\x02\x83\x00\x00\x00\x04\x05\x02\xa4\x00\x00\x00\x04\x07\x02\x95\x00\x00\x00\x01\x06\x04\xc4\x00\x00\x00\x01\x19\x8b\x00\x00\x00\x01\x05\x03\x84\x84\x04\x08\x05O\x00\x00\x00\x00"},
    {2571, 86,
      "\x01\x11\x00\x10\x06\x11\x01\x12\x01\x03\x08\x1b\x08%\x08\x13\x05\x00\x00\x00\x01\x11\x01\x10\x06\x12\x01\x11\x01%\x0e\x13\x0b\x03\x0e\x1b\x0e\x00\x00\x02$\x00\x03\x0e\x0b\x0b>\x0b\x00\x00\x03$\x00\x03\x08\x0b\x0b>\x0b\x00\x00\x04\x34\x00\x03\x0e:\x0b;\x0bI\x13?\x0c\x02\x0a\x00\x00\x05&\x00I\x13\x00\x00\x00"},
    {2689, 130,
      "W\x00\x00\x00\x02\x00\x32\x00\x00\x00\x01\x01\xfb\x0e\x0d\x00\x01\x01\x01\x01\x00\x00\x00\x01\x00\x00\x01../sysdeps/i386/elf\x00\x00start.S\x00\x01\x00\x00\x00\x00\x05\x02\xb0\x82\x04\x08\x03\xc0\x00\x01\x33!4=%\"\x03\x18 YZ!\"\[\x02\x01\x00\x01\x01#\x00\x00\x00\x02\x00\x1d\x00\x00\x00\x01\x01\xfb\x0e\x0d\x00\x01\x01\x01\x01\x00\x00\x00\x01\x00\x00\x01\x00init.c\x00\x00\x00"
      "\x00\x00"},
    {3109, 211,
      "GNU C 4.1.2 20061115 (prerelease) (Debian 4.1.1-21)\x00init.c\x00short int\x00/build/buildd/glibc-2.3.6.ds1/build-tree/glibc-2.3.6/csu\x00lo"
      "ng long int\x00unsigned char\x00long long unsigned int\x00short unsigned int\x00_IO_stdin_used\x00"},
    {724, 38,
      "U\x89\xe5S\x83\xec\x04\xe8\x00\x00\x00\x00[\x81\xc3\x98\x12\x00\x00\x8b\x93\xfc\xff\xff\xff\x85\xd2t\x05\xe8\xa6\xff\xff\xffX[\xc9\xc3"},
    {596, 11,
      "U\x89\xe5\x83\xec\x08\xe8u\x00\x00\x00"},
    {1124, 19,
      "U\x89\xe5S\x83\xec\x04\xe8\x00\x00\x00\x00[\x81\xc3\x08\x11\x00\x00"},
    {1494, 58,
      "\x00GCC: (GNU) 4.1.2 20061115 (prerelease) (Debian 4.1.1-21)\x00"},
    {2819, 162,
      "\x9e\x00\x00\x00\x02\x00T\x00\x00\x00\x01\x01\xfb\x0e\x0d\x00\x01\x01\x01\x01\x00\x00\x00\x01\x00\x00\x01/build/buildd/glibc-2.3.6.ds1/build-tree/i386-libc/csu\x00\x00\x63rti.S\x00\x01\x00\x00\x00\x00\x05\x02\xd4\x82\x04\x08\x03\x0b\x01!/!=Z!gg//Z!!!\x02\x01\x00\x01\x01\x00\x05\x02T\x82"
      "\x04\x08\x03#\x01!/=\x02\x05\x00\x01\x01\x00\x05\x02\x64\x84\x04\x08\x03\x33\x01!/!=Z!\x02\x06\x00\x01\x01"},
    {2273, 149,
      "\x91\x00\x00\x00\x02\x00V\x00\x00\x00\x04\x01\x82\x00\x00\x00/build/buildd/glibc-2.3.6.ds1/build-tree/i386-libc/csu/crti.S\x00/build/buildd/glibc-2.3.6.ds1/build-tree/glibc-2.3"
      ".6/csu\x00GNU AS 2.17\x00\x01\x80"},
    {2657, 16,
      "\x01\x11\x00\x10\x06\x03\x08\x1b\x08%\x08\x13\x05\x00\x00\x00"},
    {1880, 48,
      ",\x00\x00\x00\x02\x00\x0c\x01\x00\x00\x04\x00\x00\x00\x00\x00\xd4\x82\x04\x08&\x00\x00\x00T\x82\x04\x08\x0b\x00\x00\x00\x64\x84\x04\x08\x13\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"},
    {768, 83,
      "U\x89\xe5\x83\xec\x08\x80=\x9c\x95\x04\x08\x00t\x0c\xeb\x1c\x83\xc0\x04\xa3\x98\x95\x04\x08\xff\xd2\xa1\x98\x95\x04\x08\x8b\x10\x85\xd2u\xeb\xc6\x05\x9c\x95\x04\x08\x01\xc9\xc3\x90U\x89\xe5\x83\xec\x08\xa1\xa8\x94\x04\x08\x85\xc0t\x12\xb8\x00\x00\x00\x00\x85\xc0t\x09\xc7\x04$\xa8\x94\x04\x08\xff\xd0\xc9\xc3"},
    {1428, 8,
      "\x00\x00\x00\x00\xa4\x94\x04\x08"},
    {1176, 4,
      "\xff\xff\xff\xff"},
    {1184, 4,
      "\xff\xff\xff\xff"},
    {1143, 5,
      "\xe8\x84\xfe\xff\xff"},
    {607, 5,
      "\xe8\xcc\x00\x00\x00"},
    {1552, 58,
      "\x00GCC: (GNU) 4.1.2 20061115 (prerelease) (Debian 4.1.1-21)\x00"},
    {5376, 400,
      "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\x19\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\x1a\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\x1b\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\x1c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\x1d\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\x1e\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00 \x00"
      "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00!\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00\xf1\xff\x0c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00\xf1\xff(\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00\xf1\xff/\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00\xf1\xff:\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00\xf1\xffx\x00\x00\x00\xd4\x82\x04\x08\x00\x00\x00\x00\x02\x00\x0c\x00\x88\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00\xf1\xff"
      "\x93\x00\x00\x00\x98\x94\x04\x08\x00\x00\x00\x00\x01\x00\x10\x00\xa1\x00\x00\x00\xa0\x94\x04\x08\x00\x00\x00\x00\x01\x00\x11\x00\xaf\x00\x00\x00\xa8\x94\x04\x08\x00\x00\x00\x00\x01\x00\x12\x00\xbc\x00\x00\x00\x9c\x95\x04\x08\x01\x00\x00\x00\x01\x00\x17\x00\xcb\x00\x00\x00\x98\x95\x04\x08\x00\x00\x00\x00\x01\x00\x16\x00\xd2\x00\x00\x00\x00\x83\x04\x08\x00\x00\x00\x00\x02\x00\x0c\x00\xe8\x00\x00\x00\x30\x83\x04\x08\x00\x00\x00\x00\x02\x00\x0c\x00\x88\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00\xf1\xff"
      "\xf4\x00\x00\x00\x9c\x94\x04\x08\x00\x00\x00\x00\x01\x00\x10\x00"},
    {1072, 49,
      "U\x89\xe5S\xbb\x98\x94\x04\x08\x83\xec\x04\xa1\x98\x94\x04\x08\x83\xf8\xfft\x16\x8dv\x00\x8d\xbc'\x00\x00\x00\x00\x83\xeb\x04\xff\xd0\x8b\x03\x83\xf8\xffu\xf4X[]\x90\xc3"},
    {1180, 4,
      "\x00\x00\x00\x00"},
    {1188, 4,
      "\x00\x00\x00\x00"},
    {1172, 4,
      "\x00\x00\x00\x00"},
    {1192, 4,
      "\x00\x00\x00\x00"},
    {612, 5,
      "\xe8\xc7\x01\x00\x00"},
    {1726, 58,
      "\x00GCC: (GNU) 4.1.2 20061115 (prerelease) (Debian 4.1.1-21)\x00"},
    {617, 2,
      "\xc9\xc3"},
    {1148, 4,
      "Y[\xc9\xc3"},
    {1784, 58,
      "\x00GCC: (GNU) 4.1.2 20061115 (prerelease) (Debian 4.1.1-21)\x00"},
    {2981, 128,
      "|\x00\x00\x00\x02\x00T\x00\x00\x00\x01\x01\xfb\x0e\x0d\x00\x01\x01\x01\x01\x00\x00\x00\x01\x00\x00\x01/build/buildd/glibc-2.3.6.ds1/build-tree/i386-libc/csu\x00\x00\x63rtn.S\x00\x01\x00\x00\x00\x00\x05\x02i\x82\x04\x08\x03\x09\x01!\x02\x01\x00\x01\x01\x00\x05\x02|\x84\x04\x08\x03\x12\x01!!!\x02\x01\x00\x01\x01"
      ""},
    {2422, 149,
      "\x91\x00\x00\x00\x02\x00\x66\x00\x00\x00\x04\x01$\x01\x00\x00/build/buildd/glibc-2.3.6.ds1/build-tree/i386-libc/csu/crtn.S\x00/build/buildd/glibc-2.3.6.ds1/build-tree/glibc-2.3"
      ".6/csu\x00GNU AS 2.17\x00\x01\x80"},
    {2673, 16,
      "\x01\x11\x00\x10\x06\x03\x08\x1b\x08%\x08\x13\x05\x00\x00\x00"},
    {1928, 40,
      "$\x00\x00\x00\x02\x00\xa1\x01\x00\x00\x04\x00\x00\x00\x00\x00i\x82\x04\x08\x02\x00\x00\x00|\x84\x04\x08\x04\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"},
    {762, 6,
      "\x90\x90\x90\x90\x90\x90"},
    {851, 44,
      "\x90\x8dL$\x04\x83\xe4\xf0\xffq\xfcU\x89\xe5Q\x83\xec\x04\xc7\x04$\x88\x84\x04\x08\xe8\x0b\xff\xff\xff\xb8\x00\x00\x00\x00\x83\xc4\x04Y]\x8d\x61\xfc\xc3"},
    {1160, 12,
      "hello world\x00"},
    {1610, 58,
      "\x00GCC: (GNU) 4.1.2 20061115 (prerelease) (Debian 4.1.1-21)\x00"},
    {895, 164,
      "\x90U\x89\xe5WVS\xe8\x98\x00\x00\x00\x81\xc3\xed\x11\x00\x00\x83\xec\x0c\x8d\x83 \xff\xff\xff\x8d\xbb \xff\xff\xff)\xf8\xc1\xf8\x02\x8dp\xff\x83\xfe\xfft\x0c\x8dv\x00\xff\x14\xb7N\x83\xfe\xffu\xf7\x8d\xb4&\x00\x00\x00\x00\xe8\x9f\x00\x00\x00\x83\xc4\x0c[^_]\xc3\x8dv\x00U\x89\xe5WVS\xe8H\x00\x00\x00\x81\xc3\x9d\x11\x00\x00\x83\xec\x0c\xe8k\xfe\xff\xff\x8d\x83 \xff\xff\xff\x8d\x93 \xff\xff\xff)\xd0\xc1\xf8\x02\x89\x45\xf0t\x1c"
      "\x31\xff\x89\xd6\x8d\xb6\x00\x00\x00\x00\x8d\xbc'\x00\x00\x00\x00G\xff\x16\x83\xc6\x04\x39}\xf0u\xf5\x83\xc4\x0c[^_]\xc3"},
    {1668, 58,
      "\x00GCC: (GNU) 4.1.2 20061115 (prerelease) (Debian 4.1.1-21)\x00"},
    {1059, 13,
      "\x8b\x1c$\xc3\x90\x90\x90\x90\x90\x90\x90\x90\x90"},
    {1121, 3,
      "\x90\x90\x90"},
    {5776, 1244,
      "\x01\x01\x00\x00\xa4\x94\x04\x08\x00\x00\x00\x00\x01\x00\x11\x00\x0e\x01\x00\x00\x94\x84\x04\x08\x00\x00\x00\x00\x01\x00\x0f\x00\x1c\x01\x00\x00\xa8\x94\x04\x08\x00\x00\x00\x00\x01\x00\x12\x00(\x01\x00\x00\x30\x84\x04\x08\x00\x00\x00\x00\x02\x00\x0c\x00/\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00\xf1\xff>\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00\xf1\xff|\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00\xf1\xff\x83\x01\x00\x00\xac\x94\x04\x08\x00\x00\x00\x00\x01\x02\x13\x00"
      "\x8c\x01\x00\x00\x98\x94\x04\x08\x00\x00\x00\x00\x00\x02\xf1\xff\x9d\x01\x00\x00\x98\x94\x04\x08\x00\x00\x00\x00\x00\x02\xf1\xff\xb0\x01\x00\x00\x98\x94\x04\x08\x00\x00\x00\x00\x00\x02\xf1\xff\xc1\x01\x00\x00x\x95\x04\x08\x00\x00\x00\x00\x01\x02\x15\x00\xd7\x01\x00\x00\x98\x94\x04\x08\x00\x00\x00\x00\x00\x02\xf1\xff\xea\x01\x00\x00\x80\x84\x04\x08\x04\x00\x00\x00\x11\x00\x0e\x00\xf1\x01\x00\x00\x94\x95\x04\x08\x00\x00\x00\x00\x11\x02\x16\x00\xfe\x01\x00\x00\x80\x83\x04\x08M\x00\x00\x00\x12\x00\x0c\x00"
      "\x0e\x02\x00\x00\x00\x00\x00\x00\x7f\x01\x00\x00\x12\x00\x00\x00\x1e\x02\x00\x00T\x82\x04\x08\x00\x00\x00\x00\x12\x00\x0a\x00$\x02\x00\x00\xb0\x82\x04\x08\x00\x00\x00\x00\x12\x00\x0c\x00+\x02\x00\x00\xd0\x83\x04\x08S\x00\x00\x00\x12\x00\x0c\x00;\x02\x00\x00\x9c\x95\x04\x08\x00\x00\x00\x00\x10\x00\xf1\xffG\x02\x00\x00T\x83\x04\x08+\x00\x00\x00\x12\x00\x0c\x00L\x02\x00\x00\x00\x00\x00\x00\xe7\x00\x00\x00\x12\x00\x00\x00i\x02\x00\x00\x90\x95\x04\x08\x00\x00\x00\x00 \x00\x16\x00"
      "t\x02\x00\x00\x64\x84\x04\x08\x00\x00\x00\x00\x12\x00\x0d\x00z\x02\x00\x00\x9c\x95\x04\x08\x00\x00\x00\x00\x10\x00\xf1\xff\x81\x02\x00\x00#\x84\x04\x08\x00\x00\x00\x00\x12\x02\x0c\x00\x98\x02\x00\x00\xa0\x95\x04\x08\x00\x00\x00\x00\x10\x00\xf1\xff\x9d\x02\x00\x00\x84\x84\x04\x08\x04\x00\x00\x00\x11\x00\x0e\x00\xac\x02\x00\x00\x90\x95\x04\x08\x00\x00\x00\x00\x10\x00\x16\x00\xb9\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00 \x00\x00\x00\xcd\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00 \x00\x00\x00"
      "\x00\x61\x62i-note.S\x00../sysdeps/i386/elf/start.S\x00init.c\x00initfini.c\x00/build/buildd/glibc-2.3.6.ds1/build-tree/i386-libc/csu/crti.S\x00\x63\x61ll_gmo"
      "n_start\x00\x63rtstuff.c\x00__CTOR_LIST__\x00__DTOR_LIST__\x00__JCR_LIST__\x00\x63ompleted.5621\x00p.5619\x00__do_global_dtors_aux\x00\x66rame_dummy\x00__CTOR_END__"
      "\x00__DTOR_END__\x00__FRAME_END__\x00__JCR_END__\x00__do_global_ctors_aux\x00/build/buildd/glibc-2.3.6.ds1/build-tree/i386-libc/csu/crtn.S\x00main"
      ".c\x00_DYNAMIC\x00__fini_array_end\x00__fini_array_start\x00__init_array_end\x00_GLOBAL_OFFSET_TABLE_\x00__init_array_start\x00_fp_hw\x00__dso_handle\x00__"
      "libc_csu_fini\x00puts@@GLIBC_2.0\x00_init\x00_start\x00__libc_csu_init\x00__bss_start\x00main\x00__libc_start_main@@GLIBC_2.0\x00\x64\x61ta_start\x00_fini\x00_edata"
      "\x00__i686.get_pc_thunk.bx\x00_end\x00_IO_stdin_used\x00__data_start\x00_Jv_RegisterClasses\x00__gmon_start__\x00"},
    {1396, 28,
      "\x00\x00\x00\x00\xac\x94\x04\x08\x00\x00\x00\x00\x00\x00\x00\x00\x82\x82\x04\x08\x92\x82\x04\x08\xa2\x82\x04\x08"},
    {564, 8,
      "t\x95\x04\x08\x06\x04\x00\x00"},
    {276, 19,
      "/lib/ld-linux.so.2\x00"},
    {522, 42,
      "\x00\x00\x02\x00\x02\x00\x01\x00\x00\x00\x01\x00\x01\x00\x10\x00\x00\x00\x10\x00\x00\x00\x00\x00\x00\x00\x10ii\x0d\x00\x00\x02\x00@\x00\x00\x00\x00\x00\x00\x00"},
    {368, 154,
      "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1a\x00\x00\x00\x00\x00\x00\x00\x7f\x01\x00\x00\x12\x00\x00\x00.\x00\x00\x00\x00\x00\x00\x00\xe7\x00\x00\x00\x12\x00\x00\x00\x1f\x00\x00\x00\x84\x84\x04\x08\x04\x00\x00\x00\x11\x00\x0e\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00 \x00\x00\x00\x00__gmon_start__\x00libc.so.6\x00puts\x00_IO_stdin_used\x00__"
      "libc_start_main\x00GLIBC_2.0\x00"},
    {1196, 200,
      "\x01\x00\x00\x00\x10\x00\x00\x00\x0c\x00\x00\x00T\x82\x04\x08\x0d\x00\x00\x00\x64\x84\x04\x08\x04\x00\x00\x00H\x81\x04\x08\x05\x00\x00\x00\xc0\x81\x04\x08\x06\x00\x00\x00p\x81\x04\x08\x0a\x00\x00\x00J\x00\x00\x00\x0b\x00\x00\x00\x10\x00\x00\x00\x15\x00\x00\x00\x00\x00\x00\x00\x03\x00\x00\x00x\x95\x04\x08\x02\x00\x00\x00\x18\x00\x00\x00\x14\x00\x00\x00\x11\x00\x00\x00\x17\x00\x00\x00<\x82\x04\x08\x11\x00\x00\x00\x34\x82\x04\x08\x12\x00\x00\x00\x08\x00\x00\x00\x13\x00\x00\x00\x08\x00\x00\x00"
      "\xfe\xff\xffo\x14\x82\x04\x08\xff\xff\xffo\x01\x00\x00\x00\xf0\xff\xffo\x0a\x82\x04\x08\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"},
    {328, 40,
      "\x03\x00\x00\x00\x05\x00\x00\x00\x04\x00\x00\x00\x02\x00\x00\x00\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"},
    {620, 64,
      "\xff\x35|\x95\x04\x08\xff%\x80\x95\x04\x08\x00\x00\x00\x00\xff%\x84\x95\x04\x08h\x00\x00\x00\x00\xe9\xe0\xff\xff\xff\xff%\x88\x95\x04\x08h\x08\x00\x00\x00\xe9\xd0\xff\xff\xff\xff%\x8c\x95\x04\x08h\x10\x00\x00\x00\xe9\xc0\xff\xff\xff"},
    {572, 24,
      "\x84\x95\x04\x08\x07\x01\x00\x00\x88\x95\x04\x08\x07\x02\x00\x00\x8c\x95\x04\x08\x07\x04\x00\x00"},
    {3320, 295,
      "\x00.symtab\x00.strtab\x00.shstrtab\x00.interp\x00.note.ABI-tag\x00.hash\x00.dynsym\x00.dynstr\x00.gnu.version\x00.gnu.version_r\x00.rel.dyn\x00.rel.plt\x00.init\x00.text"
      "\x00.fini\x00.rodata\x00.eh_frame\x00.ctors\x00.dtors\x00.jcr\x00.dynamic\x00.got\x00.got.plt\x00.data\x00.bss\x00.comment\x00.debug_aranges\x00.debug_pubnames\x00.debug_inf"
      "o\x00.debug_abbrev\x00.debug_line\x00.debug_str\x00"},
    {0, 52,
      "\x7f\x45LF\x01\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00\x03\x00\x01\x00\x00\x00\xb0\x82\x04\x08\x34\x00\x00\x00 \x0e\x00\x00\x00\x00\x00\x00\x34\x00 \x00\x07\x00(\x00\"\x00\x1f\x00"},
    {3616, 480,
      "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1b\x00\x00\x00\x01\x00\x00\x00\x02\x00\x00\x00\x14\x81\x04\x08\x14\x01\x00\x00\x13\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00#\x00\x00\x00\x07\x00\x00\x00\x02\x00\x00\x00(\x81\x04\x08(\x01\x00\x00 \x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x31\x00\x00\x00\x05\x00\x00\x00"
      "\x02\x00\x00\x00H\x81\x04\x08H\x01\x00\x00(\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x04\x00\x00\x00\x37\x00\x00\x00\x0b\x00\x00\x00\x02\x00\x00\x00p\x81\x04\x08p\x01\x00\x00P\x00\x00\x00\x05\x00\x00\x00\x01\x00\x00\x00\x04\x00\x00\x00\x10\x00\x00\x00?\x00\x00\x00\x03\x00\x00\x00\x02\x00\x00\x00\xc0\x81\x04\x08\xc0\x01\x00\x00J\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00G\x00\x00\x00\xff\xff\xffo\x02\x00\x00\x00\x0a\x82\x04\x08"
      "\x0a\x02\x00\x00\x0a\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x02\x00\x00\x00T\x00\x00\x00\xfe\xff\xffo\x02\x00\x00\x00\x14\x82\x04\x08\x14\x02\x00\x00 \x00\x00\x00\x05\x00\x00\x00\x01\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x63\x00\x00\x00\x09\x00\x00\x00\x02\x00\x00\x00\x34\x82\x04\x08\x34\x02\x00\x00\x08\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x08\x00\x00\x00l\x00\x00\x00\x09\x00\x00\x00\x02\x00\x00\x00<\x82\x04\x08<\x02\x00\x00\x18\x00\x00\x00"
      "\x04\x00\x00\x00\x0b\x00\x00\x00\x04\x00\x00\x00\x08\x00\x00\x00u\x00\x00\x00\x01\x00\x00\x00\x06\x00\x00\x00T\x82\x04\x08T\x02\x00\x00\x17\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00p\x00\x00\x00\x01\x00\x00\x00\x06\x00\x00\x00l\x82\x04\x08l\x02\x00\x00@\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x04\x00\x00\x00"},
    {4096, 880,
      "{\x00\x00\x00\x01\x00\x00\x00\x06\x00\x00\x00\xb0\x82\x04\x08\xb0\x02\x00\x00\xb4\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x10\x00\x00\x00\x00\x00\x00\x00\x81\x00\x00\x00\x01\x00\x00\x00\x06\x00\x00\x00\x64\x84\x04\x08\x64\x04\x00\x00\x1c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x87\x00\x00\x00\x01\x00\x00\x00\x02\x00\x00\x00\x80\x84\x04\x08\x80\x04\x00\x00\x14\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x8f\x00\x00\x00\x01\x00\x00\x00"
      "\x02\x00\x00\x00\x94\x84\x04\x08\x94\x04\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x99\x00\x00\x00\x01\x00\x00\x00\x03\x00\x00\x00\x98\x94\x04\x08\x98\x04\x00\x00\x08\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\xa0\x00\x00\x00\x01\x00\x00\x00\x03\x00\x00\x00\xa0\x94\x04\x08\xa0\x04\x00\x00\x08\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\xa7\x00\x00\x00\x01\x00\x00\x00\x03\x00\x00\x00\xa8\x94\x04\x08"
      "\xa8\x04\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\xac\x00\x00\x00\x06\x00\x00\x00\x03\x00\x00\x00\xac\x94\x04\x08\xac\x04\x00\x00\xc8\x00\x00\x00\x05\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x08\x00\x00\x00\xb5\x00\x00\x00\x01\x00\x00\x00\x03\x00\x00\x00t\x95\x04\x08t\x05\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x04\x00\x00\x00\xba\x00\x00\x00\x01\x00\x00\x00\x03\x00\x00\x00x\x95\x04\x08x\x05\x00\x00\x18\x00\x00\x00"
      "\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x04\x00\x00\x00\xc3\x00\x00\x00\x01\x00\x00\x00\x03\x00\x00\x00\x90\x95\x04\x08\x90\x05\x00\x00\x0c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\xc9\x00\x00\x00\x08\x00\x00\x00\x03\x00\x00\x00\x9c\x95\x04\x08\x9c\x05\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\xce\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x9c\x05\x00\x00\x96\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
      "\x01\x00\x00\x00\x00\x00\x00\x00\xd7\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x38\x07\x00\x00x\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x08\x00\x00\x00\x00\x00\x00\x00\xe6\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xb0\x07\x00\x00%\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\xf6\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xd5\x07\x00\x00\x36\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00"
      "\x02\x01\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0b\x0a\x00\x00v\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x10\x01\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x81\x0a\x00\x00\xa4\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x1c\x01\x00\x00\x01\x00\x00\x00\x30\x00\x00\x00\x00\x00\x00\x00%\x0c\x00\x00\xd3\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x01\x00\x00\x00\x11\x00\x00\x00\x03\x00\x00\x00"
      "\x00\x00\x00\x00\x00\x00\x00\x00\xf8\x0c\x00\x00'\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00p\x13\x00\x00 \x05\x00\x00!\x00\x00\x00?\x00\x00\x00\x04\x00\x00\x00\x10\x00\x00\x00\x09\x00\x00\x00\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x90\x18\x00\x00\xdc\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00"},
    {0, 0, NULL},
};

static dump_block(void * ptr, int size)
{
    int i;

    printf("DUMP:\n");
    for(i = 0; i < size; i++) {
	if (isprint(((char *) ptr)[i]))
	    printf("%c", ((char *) ptr)[i]);
	else
	    printf(".");
	if (i % 128 == 127)
	    printf("\n");
    }
    printf("\n");
}

int writedata(CryptoCtxLocal *context, int fp, void *data, unsigned long count, long long offset)
{
    int blocksize = crypto_get_blocksize(context);
    int read, block = 0;

    crypto_write(context, fp, data, count, offset);
    memmove(filecontent + offset, data, count);
//    dump_block(filecontent, 8192);
    
    do {
	read = crypto_readblock(context, fp, block);

	if(memcmp(crypto_get_filebuf(context), filecontent + (block * blocksize), read) != 0)
	    return -1;
	block++;
    } while(read == blocksize);

    return 0;
}

int test()
{
    int i;
    CryptoCtxLocal *context = getLocalTestContext();
    int fp;
    struct TestData *data = testdata;

    filecontent = malloc(8192);
    memset(filecontent, 0, 8192);

    unlink(FILENAME);

    fp = open(FILENAME, O_RDWR | O_CREAT, S_IRWXU);

    while(data->data != NULL) {
	if (writedata(context, fp, data->data, data->count, data->offset) != 0) {
	    printf("Write check failed\n");
	    return -1;
	}
	data++;
    }

    unlink(FILENAME);

    free(filecontent);
    crypto_destroy_local_ctx(context);

    return 0;
}
